/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * DialogEditLibrary.java
 *
 * Created on 18.02.2010, 22:23:30
 */

package celsius.Dialogs;

import celsius.*;
import celsius.tools.FFilter;
import celsius.tools.toolbox;
import java.io.File;
import java.util.ArrayList;
import javax.swing.DefaultListModel;
import javax.swing.JComponent;
import javax.swing.JFileChooser;

/**
 *
 * @author cnsaeman
 */
public class EditUSBDevices extends javax.swing.JDialog {

    private final Library Lib;
    private final MainFrame MF;

    private DefaultListModel DLM;
    private StateManager SM;

    /** Creates new form DialogEditLibrary */
    public EditUSBDevices(MainFrame mf, Library lib) {
        super(mf, true);
        MF=mf;
        Lib=lib;
        initComponents();
        DLM=new DefaultListModel();
        for (String tag : Lib.usbdrives.keySet())
            DLM.addElement(tag);
        jLDevices.setModel(DLM);
        MF.RSC.SM.register(this,"noneSelected", new JComponent[] { jETFName, jETFFolder, jBtnApply, jBtnRemove, jBtnSelectFolder });
        MF.RSC.SM.switchOff(this, "noneSelected");
        toolbox.centerFrame(this);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jETFFolder = new celsius.jExtTextField();
        jBtnSelectFolder = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jLDevices = new javax.swing.JList();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jETFName = new celsius.jExtTextField();
        jBtnDone = new javax.swing.JButton();
        jBtnAdd = new javax.swing.JButton();
        jBtnApply = new javax.swing.JButton();
        jBtnRemove = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        jETFCategories = new celsius.jExtTextField();
        jBtnSelectCategories = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Setup USB devices");
        getContentPane().setLayout(new java.awt.GridLayout(1, 0));

        jPanel1.setBorder(javax.swing.BorderFactory.createEmptyBorder(5, 5, 5, 5));

        jETFFolder.setDefaultText("Enter the device's folder");

        jBtnSelectFolder.setText("Select Folder");
        jBtnSelectFolder.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnSelectFolderActionPerformed(evt);
            }
        });

        jLabel1.setText("Name:");

        jLDevices.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                jLDevicesValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(jLDevices);

        jLabel2.setText("USB Devices");

        jLabel3.setText("Folder:");

        jETFName.setDefaultText("Enter a label for the device");

        jBtnDone.setText("Done");
        jBtnDone.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnDoneActionPerformed(evt);
            }
        });

        jBtnAdd.setText("Add Device");
        jBtnAdd.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnAddActionPerformed(evt);
            }
        });

        jBtnApply.setText("Apply Changes");
        jBtnApply.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnApplyActionPerformed(evt);
            }
        });

        jBtnRemove.setText("Remove");
        jBtnRemove.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnRemoveActionPerformed(evt);
            }
        });

        jLabel4.setText("Categories:");

        jETFCategories.setDefaultText("Enter categories to be synchronized");

        jBtnSelectCategories.setText("Select Categories");
        jBtnSelectCategories.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnSelectCategoriesActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 154, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(jBtnSelectFolder)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jBtnSelectCategories)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jBtnApply))
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(jLabel4)
                                    .addComponent(jLabel3)
                                    .addComponent(jLabel1))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(jETFFolder, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 343, Short.MAX_VALUE)
                                    .addComponent(jETFCategories, javax.swing.GroupLayout.DEFAULT_SIZE, 343, Short.MAX_VALUE)
                                    .addComponent(jETFName, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 343, Short.MAX_VALUE)))))
                    .addComponent(jLabel2)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jBtnAdd)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jBtnRemove)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 327, Short.MAX_VALUE)
                        .addComponent(jBtnDone)))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 120, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jBtnAdd)
                            .addComponent(jBtnRemove)))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jETFName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jETFFolder, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jETFCategories, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jBtnSelectFolder)
                            .addComponent(jBtnSelectCategories)
                            .addComponent(jBtnApply))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jBtnDone))))
        );

        getContentPane().add(jPanel1);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jBtnSelectFolderActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnSelectFolderActionPerformed
        JFileChooser FC = new JFileChooser();
        FC.setDialogTitle("Select the folder which should be synchronized");
        FC.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
        String erd=jETFFolder.getText();
        if (erd==null) erd=".";
        FC.setCurrentDirectory(new File(erd));
        FC.setDialogType(JFileChooser.OPEN_DIALOG);
        FC.setFileFilter(new FFilter("_DIR", "Folders"));
        if (!(FC.showSaveDialog(this) == JFileChooser.CANCEL_OPTION)) {
            jETFFolder.setText(FC.getSelectedFile().getAbsolutePath());
        }
    }//GEN-LAST:event_jBtnSelectFolderActionPerformed

    private void jBtnDoneActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnDoneActionPerformed
        MF.updateStatusBar(false);
        this.setVisible(false);
        this.dispose();
        MF.RSC.SM.unregister(this);
    }//GEN-LAST:event_jBtnDoneActionPerformed

    private void jBtnAddActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnAddActionPerformed
        DLM.addElement("<empty>");
        jLDevices.setSelectedValue("<empty>", true);
    }//GEN-LAST:event_jBtnAddActionPerformed

    private void jBtnApplyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnApplyActionPerformed
        String dev=jETFName.getText();
        if (!dev.equals("<empty>")) {
            String oldname=(String)jLDevices.getSelectedValue();
            if (!oldname.equals("<empty>"))
                Lib.usbdrives.remove(oldname);
            int i=jLDevices.getSelectedIndex();
            DLM.set(i, dev);
            ArrayList<String> list=new ArrayList<String>();
            String mainfile=Lib.MainFile.get("usbdrives");
            if (mainfile==null) mainfile=new String("");
            mainfile+="|"+dev+":";
            list.add(jETFFolder.getText());
            mainfile+=jETFFolder.getText();
            String[] lst=jETFCategories.getText().split("\\|");
            for (int j=0;j<lst.length;j++) {
                mainfile+=":"+lst[j];
                list.add(lst[j]);
            }
            Lib.usbdrives.put(dev, list);
            if (mainfile.charAt(0)=='|') mainfile=mainfile.substring(1);
            Lib.MainFile.put("usbdrives",mainfile);
            Lib.setChanged(true);
        } else {
            toolbox.Warning(this,"Please enter a name for the USB device!", "Warning:");
        }
    }//GEN-LAST:event_jBtnApplyActionPerformed

    private void jBtnRemoveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnRemoveActionPerformed
        String dev=(String)jLDevices.getSelectedValue();
        int i=jLDevices.getSelectedIndex();
        DLM.remove(i);
        if (!dev.equals("<empty>")) {
            Lib.usbdrives.remove(dev);
            Lib.setChanged(true);
        }
    }//GEN-LAST:event_jBtnRemoveActionPerformed

    private void jLDevicesValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_jLDevicesValueChanged
        if (jLDevices.getSelectedIndex()==-1) {
            MF.RSC.SM.switchOff(this, "noneSelected");
            jETFName.resetText();
            jETFFolder.resetText();
        } else {
            MF.RSC.SM.switchOn(this, "noneSelected");
            String dev=(String)jLDevices.getSelectedValue();
            if (!dev.equals("<empty>")) {
                jETFName.setText(dev);
                ArrayList<String> list=Lib.usbdrives.get(dev);
                jETFFolder.setText(list.get(0));
                String cats=new String("");
                for (int i=1;i<list.size();i++)
                    cats+="|"+list.get(i);
                jETFCategories.setText(cats.substring(1));
            } else {
                jETFName.resetText();
                jETFFolder.resetText();
            }
        }
    }//GEN-LAST:event_jLDevicesValueChanged

    private void jBtnSelectCategoriesActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnSelectCategoriesActionPerformed
        ChooseCategory DCC=new ChooseCategory(MF.RSC);
        DCC.setVisible(true);
        if (DCC.selected) {
            String tmp=jETFCategories.getText();
            if (tmp.equals(jETFCategories.getDefaultText())) tmp="";
            if (tmp.length()!=0) tmp+="|";
            jETFCategories.setText(tmp+DCC.category);
        }
    }//GEN-LAST:event_jBtnSelectCategoriesActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jBtnAdd;
    private javax.swing.JButton jBtnApply;
    private javax.swing.JButton jBtnDone;
    private javax.swing.JButton jBtnRemove;
    private javax.swing.JButton jBtnSelectCategories;
    private javax.swing.JButton jBtnSelectFolder;
    private celsius.jExtTextField jETFCategories;
    private celsius.jExtTextField jETFFolder;
    private celsius.jExtTextField jETFName;
    private javax.swing.JList jLDevices;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables

}
